<html>
<head>
    <title>MOBILITY-RELEASE</title>
</head>
<body>
</body>
<script type="text/javascript">
    window.__OS = "ANDROID";
    window.JBridge = top.JBridge;
    window.Android = top.Android;
    window.DUIGatekeeper = JBridge;
    var renewCount = 5;
    var loadInDuiCount = 5;
    var interval = 200; //ms

    function loadBundle() {
        console.log("Here is the Release file")
        var headID = document.getElementsByTagName("head")[0];
        var newScript = document.createElement('script');
        newScript.type = 'text/javascript';
        newScript.id = 'mystique';
        newScript.innerHTML = window.DUIGatekeeper.loadFileInDUI('v1-index_bundle.jsa');
        headID.appendChild(newScript);
    }

    function packageUrl(service) {
      const fileContent = JSON.parse(window.DUIGatekeeper.loadFileInDUI('config.json'));
      const url = fileContent.new.package[service];
      return url;
    }

    function onEvent(_event) {
      JBridge.runInJuspayBrowser("onEvent", JSON.stringify({
                event: _event,
                service: "in.yatri.consumer",
                payload: {},
                error: false,
                errorMessage: "",
                errorCode: ""
            }), "");
    }

    function whenAvailable(notPresent, callback, count) {
        console.log('COUNT',count);
        window.setTimeout(function() {
            count -= 1;
            if (renewCount <= 0) {
              onEvent('bundle_load_failed');
            }else if (count <= 0 && notPresent) {
              console.log("renew v1-index_bundle.jsa");
              const filePath = packageUrl('in.yatri.consumer');
              renewCount -= 1;
              console.log('RENEW_COUNT',renewCount);
              window.DUIGatekeeper.renewFile(filePath);
              whenAvailable(window.DUIGatekeeper.loadFileInDUI('v1-index_bundle.jsa') == "", callback, loadInDuiCount)
            } else if (notPresent) {
              console.log("bundle not present");
              whenAvailable(window.DUIGatekeeper.loadFileInDUI('v1-index_bundle.jsa') == "", callback, count);
            } else {
              console.log("bundle present");
              // onEvent('hide_loader');
              callback();
            }
        }, interval);
    }

    console.log(packageUrl('in.yatri.consumer'));
    whenAvailable(window.DUIGatekeeper.loadFileInDUI('v1-index_bundle.jsa') == "", function() {
      loadBundle();
    }, loadInDuiCount);

    </script>
</html>